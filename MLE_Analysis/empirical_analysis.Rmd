---
title: "Empirical Analyses"
output:
  pdf_document: default
  html_document: default
  word_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(MASS)
library(ggridges)
```

# read in data
```{r}

florida_8_3 <- read.csv("~/Documents/work/Spacial_adj/Data_and_Figures/Florida_8_3_2014dm2.csv", header = TRUE)
florida_8_5 <- read.csv("~/Documents/work/Spacial_adj/Data_and_Figures/Florida_8_5_2014dm2.csv", header = TRUE)
  
oregon_6_2 <- read.csv("~/Documents/work/Spacial_adj/Data_and_Figures/Oregon_6_2_2014dm2.csv", header = TRUE)
oregon_7_1 <-  read.csv("~/Documents/work/Spacial_adj/Data_and_Figures/Oregon_7_1_2014dm2.csv", header = TRUE)
```

# Upper + lower interior/ total ratio Helper functions
```{r, echo=FALSE}
## Functions that find the most "circular" or "dense" interior / total ratio and the most linear for different numbers of pixels 

upper_bound_ratios <- function(x){
  upper <- rep(NA, length(x))
  edge <- rep(NA, length(x))
  interior <- rep(NA, length(x))
  ## get edges
  for(i in seq_along(x)){
    smaller_sqrt <- floor(sqrt(x[i]))
    smaller_square <- smaller_sqrt^2
    
    larger_sqrt <- ceiling(sqrt(x[i]))
    
    remainder <- x[i] %% smaller_square
    
    if (remainder > smaller_sqrt){
      edge[i] <- 4 * larger_sqrt
    }
    
    if (remainder <= smaller_sqrt){
      edge[i] <- (2*smaller_sqrt) + 2*(1+smaller_sqrt)
    }
    
    if (remainder == 0){
      edge[i] <- 4 * larger_sqrt
    }
  }
  
  #get interiors
  for (i in seq_along(x)){
    interior[i] <- 4 * x[i]
    interior[i] <- interior[i] - edge[i]
  }
  
  for (i in seq_along(x)){
    if (x[i] == 1){
      upper[i] <- 0
      next  
    }
    if (x[i] == 2){
      upper[i] <- 0.25
      next
    }
    if (x[i] == 3){
      upper[i] <- 0.5
      next 
    }
    
    upper[i] <- interior[i] / (interior[i] + edge[i])
  }
  
  
  return(upper)
}

lower_bound_ratios <- function(x){
  lower <- rep(NA, length(x))
  edge <- rep(NA, length(x))
  interior <- rep(NA, length(x))
  
  for (i in seq_along(x)){
    if(x[i] == 1){
      edge[i] <- 4
      next
    }
    
    if (x[i] == 2){
      edge[i] <- 6  
      next
    }
    
      edge[i] <- (2 * (x[i] - 2)) + 6 # The six accounts for the two end pixels 
  }
  
  for (i in seq_along(x)){
    if(x[i] == 1){
    interior[i] <- 0
     lower[i] <- interior[i] / (interior[i] + edge[i])
      next
    }
    
    if (x[i] == 2){
     interior[i] <- 2
      lower[i] <- interior[i] / (interior[i] + edge[i])
      next
    }
    
     interior[i] <- ((4 * x[i]) - edge[i])
     lower[i] <- interior[i] / (interior[i] + edge[i])
  }
  return (lower)
}


```

# Sifting out edge-case with artificial ratio inflation

The base raster adjacentcy function that we used when calculating interiror/total ratios made a wrap-around adjacentcy assumption, inflating the adjacentcy of corner and edge pixels. We corrected for it by setting ratios above the maximum to NA. 

```{r}
oregon_6_2$eco_II <- "6.2"  ## Put in Ecoregion labels 
oregon_7_1$eco_II <- "7.1"
florida_8_3$eco_II <- "8.3"
florida_8_5$eco_II <- "8.5"

florida <- rbind(florida_8_3, florida_8_5) 
oregon <- rbind(oregon_6_2, oregon_7_1)

florida$size_ha <- florida$sizw * 0.09  ## Convert Pixels to ha
oregon$size_ha <- oregon$sizw * 0.09

florida$state <- "FL"  ## State Labels 
oregon$state <- "OR"
final <- rbind(florida, oregon)


final$ratio[(final$ratio > 0.25) & (final$sizw == 2)] <- NA
final$ratio[(final$ratio > 0.33) & (final$sizw == 3)] <- NA
final$ratio[(final$ratio > 0.50) & (final$sizw == 4)] <- NA
final$ratio[(final$ratio > 0.5 ) & (final$sizw == 5)] <- NA
final$ratio[(final$ratio > 0.55333333) & (final$sizw == 6)] <- NA
final$ratio[(final$ratio > 0.5714286) & (final$sizw == 7)] <- NA
final$ratio[(final$ratio >  0.7083333) & (final$sizw == 12)] <- NA
final$ratio[(final$ratio >  0.7631579) & (final$sizw == 19)] <- NA

```


## Subset Dataset for estimates of mixed disturbence types, and unknowns
```{r}

unknowns <- final[grep("Unknown", final$dist_name) ,]   
no_unknowns <- dplyr::anti_join(final, unknowns, by = "dist_name") 
mixed_disturbence <- final[grep(",", final$dist_name), ]
single_disturbence <- dplyr::anti_join(final, mixed_disturbence, by = "dist_name")

single_disturbence <- na.omit(single_disturbence)

no_unknowns_mixed_disturbence <- dplyr::anti_join(mixed_disturbence, unknowns, by = "dist_name") 
no_unknowns_single_disturbence <- dplyr::anti_join(single_disturbence, unknowns, by = "dist_name")
unknown_only <- dplyr::anti_join(unknowns, mixed_disturbence, by = "dist_name")


disturbences_names <- c("Unknown","Other Mechanical","Prescribed Fire", "Wildfire", "Thinning","Mastication","Herbicide","Clearcut", "Wildland Fire") # These are the disturbences that are common between 4 ecoregions

## Set up common color schemes 
disturbence_colors <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')
eco_region_colors <- c('#df65b0', '#67001f', '#081d58','#7fcdbb') # Oregon then Florida implied
state_colors <- c('#980043', "#225ea8")
```



## Estimate qa/qc stats for supplemental table 1
```{r}
## overall size ratios
library(lemon)
library(knitr)

## Estimate unknown disturbence in an object 
# table <- list()
# table$percent_unknown_disturbence_event <- dim(unknowns)[1]/dim(final)[1]
# table$percent_unknown_single_area <- sum(unknown_only$size_ha)/ sum(final$size_ha)
# table$percent_unknown_single_event <-  dim(unknown_only)[1]/dim(final)[1]
# table$pecent_mixed_disturbence_event <- dim(mixed_disturbence)[1] /dim(final)[1]
# table$percent_unknown_area <- sum(unknowns$size_ha) / sum(final$size_ha)
# table$pecent_mixed_disturbence_area <- sum(mixed_disturbence$size_ha) / sum(final$size_ha)
# table$percent_mixed_no_unknows <- sum(no_unknowns_mixed_disturbence$size_ha)/ sum(final$size_ha)
# print(table)
# table$percent_mixed_no_unknowns_event <- dim(no_unknowns_mixed_disturbence)[1]/dim(final)[1]


for(i in seq_along(disturbences_names)){
  subset <- single_disturbence[single_disturbence$dist_name == disturbences_names[i], ]
  percent_event <- dim(subset)[1] / dim(final)[1]
  percent_area <- sum(na.omit(subset$size_ha))/ sum(na.omit(final$size_ha))
  
  print(paste(disturbences_names[i], ":", "Pecent event:", percent_event, "Percent area:", percent_area ))
  
}



```



## Density Figures
```{r}
library(dplyr)
library(ggplot2)

## Ecoregion in ggridges
  na.omit(single_disturbence[single_disturbence$dist_name %in% disturbences_names, ]) %>%
ggplot( aes(x = size_ha, y = eco_II, fill = eco_II)) + scale_x_continuous(trans="log")+ geom_density_ridges() +
  geom_vline(xintercept = 0.09)+
theme(panel.background = element_blank(), 
      axis.text.y = element_blank(), 
      axis.title.y = element_blank(), 
      axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      legend.position = "none"
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Disturbance Event Size ha") + 
    #ggtitle("Ecoregion")+
  scale_fill_manual(values= eco_region_colors)  
  
### Disturbence Density Plots 
na.omit(single_disturbence[single_disturbence$dist_name %in% disturbences_names, ]) %>%
ggplot( aes(x = size_ha, y = dist_name, fill = dist_name)) + scale_x_continuous(trans="log", limits = 0.09)+ geom_density_ridges() +
  geom_vline(xintercept = 0.09)+
theme(panel.background = element_blank(),
      axis.text.y = element_blank(),
      axis.title.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      legend.position = "none"
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Disturbance Event Size ha") + 
  #ggtitle("Size Distributions")+
  scale_fill_manual(values= disturbence_colors)  
```



## KS tests for Supplemental Table 2

```{r, echo=TRUE}

### Making Disturbence-level objects
fire_only <- single_disturbence[grep("ire", single_disturbence$dist_name),]
wildland <- fire_only[grep("Wildland", fire_only$dist_name),]
wildfire <- fire_only[grep("Wildfire", fire_only$dist_name),]
Prescribed <- fire_only[grep("Prescribed Fire", fire_only$dist_name),]

prescribed <- Prescribed
clearcut_only <- single_disturbence[grep("Clear", single_disturbence$dist_name),]
herbicide_only <- single_disturbence[grep("Herbicide", single_disturbence$dist_name),]
thining_only <- single_disturbence[grep("Thinning", single_disturbence$dist_name),]
other_mechanical <- single_disturbence[grep("Other Mechanical", single_disturbence$dist_name),]
mastication <- single_disturbence[single_disturbence$dist_name == "Mastication",]
herbicide <- single_disturbence[single_disturbence$dist_name == "Herbicide",]
unknown_only <- unknown_only


options(digits = 3)
dist_size<-list(clearcut_only$sizw, wildland$sizw, wildfire$sizw, prescribed$sizw, thining_only$sizw, other_mechanical$sizw, unknown_only$sizw, mastication$sizw, herbicide$sizw)
names(dist_size) <- c("Clearcut", "Wildland Fire", "Wildfire", "Prescribed", "Thinning","Other mechanical", "Unknown", "Mastication", "Herbicide" )

size_dist_resulsts <- list()

iterator <- 0
for ( i in 1:length(names(dist_size))){
  for (j in 1:length(names(dist_size))){
    iterator <- iterator + 1
    results <- ks.test(dist_size[[i]],dist_size[[j]], alternative = "two.sided")
    results$names <- paste(names(dist_size)[i], "x", names(dist_size)[j])
    size_dist_resulsts[[iterator]] <- results
  }
}
 
options(digits = 3)
sig <- rep(NA, length(names(dist_size))^2)
KS_results <- list()
KS_results$combination  <- rep(NA, length(names(dist_size))^2)
KS_results$pval <- rep(NA, length(names(dist_size))^2)
KS_results$sig <- rep(NA, length(names(dist_size))^2)
KS_results$D <- rep(NA, length(names(dist_size))^2)
 KS_results <- as.data.frame(KS_results)

for (i in 1:(length(names(dist_size))^2)){

  KS_results$pval[i] <- size_dist_resulsts[[i]]$p.value
  KS_results$combination[i] <- paste(size_dist_resulsts[[i]]$names)
  KS_results$sig[i] <- FALSE
  KS_results$D[i] <- size_dist_resulsts[[i]]$statistic
 
  
  if(size_dist_resulsts[[i]]$p.value < 0.000104) { # post Bonferoni correction alpha value (0.05/ (45 + 3))
   sig[i] <- paste(size_dist_resulsts[[i]]$names)
   KS_results$sig[i] <- TRUE
   print("Found one!")
  }
    
}
 KS_results <- as.list(KS_results)
state_size <- ks.test(single_disturbence[single_disturbence$state == "OR",]$sizw, single_disturbence[single_disturbence$state == "FL",]$sizw )
KS_results$combination[length(names(dist_size))^2 +1] <- "Oregon x Florida"
KS_results$pval[length(names(dist_size))^2 +1] <- state_size$p.value
KS_results$sig[length(names(dist_size))^2 +1] <-  state_size$p.value < 0.000104
KS_results$D[length(names(dist_size))^2 +1] <- state_size$statistic

fl_8_3_8_5 <- ks.test(single_disturbence[single_disturbence$eco_II == "8.5",]$sizw, single_disturbence[single_disturbence$eco_II == "8.3",]$sizw )
or_6_2_7_1 <- ks.test(single_disturbence[single_disturbence$eco_II == "6.2",]$sizw, single_disturbence[single_disturbence$eco_II == "7.1",]$sizw )

KS_results$combination[length(names(dist_size))^2 +2] <- paste("8.5 x 8.3")
KS_results$pval[length(names(dist_size))^2 +2] <- fl_8_3_8_5$p.value
KS_results$sig[length(names(dist_size))^2 +2] <-  fl_8_3_8_5$p.value < 0.000104
KS_results$D[length(names(dist_size))^2 +2] <- fl_8_3_8_5$statistic

KS_results$combination[length(names(dist_size))^2 +3] <- paste("6.2 x 7.1")
KS_results$pval[length(names(dist_size))^2 +3] <- or_6_2_7_1$p.value
KS_results$sig[length(names(dist_size))^2 +3] <-  or_6_2_7_1$p.value < 0.000104
KS_results$D[length(names(dist_size))^2 +3] <- or_6_2_7_1$statistic


KS_results <- as.data.frame(KS_results)
KS_results <- KS_results[KS_results$pval != 1, ]

### Make table with results 
options(knitr.table.format = "html")

KS_results[,c(1:2, 4)] %>%
 # select(combination, pval, D) %>%
 kable(  booktabs = T, escape = F, digits = 5, row.names = FALSE, col.names = c("Comparison", "P value", "D statistic")) %>%
  kable_styling(latex_options = "striped", full_width = F) %>%
  #select(KS_results$sig == TRUE) %>%
  row_spec(which(KS_results$sig), bold = T, background = "#ADD8E6")# %>%
  
write.csv2(KS_results, row.names = FALSE, file = "")


```



# MLE Curve fitting

The Modifide Michaelis Menten curve was chosen based on it's ability to match the null-model data. Other MLE cuvrves considered are in the Draft of Liklyhood file. Curves were compared excluding single, double, and triple pixels. 



```{r, echo = FALSE}

## Function defining the modifide Michaelis Menten curve
ic=c(4,1,1,1)
MMLnLpower  <- function(beta, ratio, sizw){  ## define likelihood
  LL = -sum(dnorm(ratio,(beta[2]*(sizw^beta[3]))/(beta[1]+(sizw^beta[3])),beta[4], log = TRUE))
  print(LL)
  if(!is.finite(LL)) return(1000)
  return(LL)
}
```

*State-level hierarchy*

```{r}

## Null
null_model_conditional <- single_disturbence$sizw >3 & single_disturbence$dist_name %in% disturbences_names 
ic=c(1.416, 0.984, 0.444, 0.101)
all_param <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[null_model_conditional,]$ratio, sizw = single_disturbence[null_model_conditional,]$sizw) 

## Oregon and Florida
oregon_model_conditional <- null_model_conditional &  single_disturbence$state =="OR"
ic=c(1.416, 0.984, 0.444, 0.101)
oregon_param <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[ oregon_model_conditional,]$ratio, sizw = single_disturbence[oregon_model_conditional,]$sizw)

ic=c(0.0005,0.5,1,1)
florida_model_conditional <- null_model_conditional &  single_disturbence$state =="FL"
florida_param <- optim(ic,MMLnLpower,method="L-BFGS-B",ratio = single_disturbence[florida_model_conditional,]$ratio, sizw = single_disturbence[florida_model_conditional,]$sizw)

## Compare? 
dev.null <- 2*all_param$value         ## null model
dev.tmt  <- 2*oregon_param$value + 2*florida_param$value      
LR       <- dev.null - dev.tmt        ## Likelihood ratio
pval     <- 1 - pchisq(LR,4)
pval # Significant 

 check_if_valid_subset <- length(single_disturbence[florida_model_conditional,]$ratio) + length(single_disturbence[oregon_model_conditional,]$ratio) == length(single_disturbence[null_model_conditional,]$ratio)

 print(paste("Valid subset?", check_if_valid_subset))

## Eco region within state

conditional_fl_8_3  <- null_model_conditional & single_disturbence$state =="FL" & single_disturbence$eco_II == "8.3" 
conditional_fl_8_5 <- null_model_conditional &  single_disturbence$state =="FL" & single_disturbence$eco_II == "8.5" 

conditional_or_6_2 <- null_model_conditional &  single_disturbence$state =="OR" & single_disturbence$eco_II == "6.2" 
conditional_or_7_1 <- null_model_conditional &  single_disturbence$state =="OR" & single_disturbence$eco_II == "7.1" 

ic=c(0.0005,0.5,1,1)
fl_8_3 <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[conditional_fl_8_3 ,]$ratio, sizw = single_disturbence[conditional_fl_8_3,]$sizw)

fl_8_5 <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[conditional_fl_8_5 ,]$ratio, sizw = single_disturbence[conditional_fl_8_5,]$sizw)

or_6_2 <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[conditional_or_6_2 ,]$ratio, sizw = single_disturbence[conditional_or_6_2,]$sizw)

or_7_1 <- optim(ic,MMLnLpower,method="L-BFGS-B", ratio = single_disturbence[conditional_or_7_1 ,]$ratio, sizw = single_disturbence[conditional_or_7_1,]$sizw)
   
   ## Comparison
    dev.null <- 2*florida_param$value  + 2*oregon_param$value     ## null model
    dev.tmt  <- 2*fl_8_3$value + 2*fl_8_5$value + 2*or_6_2$value + 2*or_7_1$value  # 8 params in the null, 16 * 4
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,8)
    pval # Significant
    
 fl_subset <- length(single_disturbence[florida_model_conditional,]$ratio) == (length(single_disturbence[conditional_fl_8_3 ,]$ratio) + length(single_disturbence[conditional_fl_8_5 ,]$ratio))
 
 or_subset <- length(single_disturbence[oregon_model_conditional,]$ratio) == (length(single_disturbence[conditional_or_6_2 ,]$ratio) + length(single_disturbence[conditional_or_7_1 ,]$ratio))
 
 print(paste("Valid subset?", (fl_subset & or_subset)))
     
## disturbence classes within ecoregion within state
ic=c(2.5,1,1,1)

run_optim <- function (conditional, disturbences_names){
  conditional <- conditional & single_disturbence$dist_name == disturbences_names
  PR <-  optim(ic,MMLnLpower,method="SANN", ratio = single_disturbence[conditional,]$ratio, sizw = na.omit(single_disturbence[conditional,]$sizw))
  return(PR)
}

names <- disturbences_names
mle_output <- list()

## FL 8.3
length_dists <- 0
failed <- ""
for (i in seq_along(names)){
  mle_output$florida_8_3[[i]] <- run_optim(conditional_fl_8_3, names[i])
  if (mle_output$florida_8_3[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed <- c(failed, paste(names[i]))
  }
  
  length_dists <- length_dists + length(single_disturbence[conditional_fl_8_3 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_fl_8_3,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      paste("ERROR: INVALID subset, disturbences length :",length_dists, " 8.3 length", length(single_disturbence[conditional_fl_8_3,]$ratio))
    }
  }
}
failed

## Fl 8.5
length_dists <- 0
failed <- ""
for (i in seq_along(names)){
  mle_output$florida_8_5[[i]] <- run_optim(conditional_fl_8_5, names[i])
  if (mle_output$florida_8_5[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed <- c(failed, paste(names[i]))
  }
  
  length_dists <- length_dists + length(single_disturbence[conditional_fl_8_5 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_fl_8_5,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      print(paste("ERROR: INVALID subset, disturbences length :",length_dists, " 8.3 length", length(single_disturbence[conditional_fl_8_5,]$ratio)))
    }
  }
}
failed

## OR 6.2
length_dists <- 0
failed <- ""
for (i in seq_along(names)){
  mle_output$oregon_6_2[[i]] <- run_optim(conditional_or_6_2, names[i])
  if (mle_output$oregon_6_2[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed <- c(failed, paste(names[i]))
  }
  
  length_dists <- length_dists + length(single_disturbence[conditional_or_6_2 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_or_6_2,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      paste("ERROR: INVALID subset, disturbences length :",length_dists, "ecoregion length", length(single_disturbence[conditional_or_6_2,]$ratio))
      
    }
  }
}
failed

## OR 7.1
length_dists <- 0
failed <- ""
for (i in seq_along(names)){
  mle_output$oregon_7_1[[i]] <- run_optim(conditional_or_7_1, names[i])
  if (mle_output$oregon_7_1[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    
    failed <- c(failed, paste(names[i]))
  }
  
  length_dists <- length_dists + length(single_disturbence[conditional_or_7_1 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_or_7_1,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      print(paste("ERROR: INVALID subset, disturbences length :",length_dists, "ecoregion length", length(single_disturbence[conditional_or_7_1,]$ratio)))
    }
  }
}

failed

   # Comparison
dev.null <- 2*fl_8_3$value + 2*fl_8_5$value + 2*or_6_2$value + 2*or_7_1$value        ##null model, 16 params
    dev.tmt  <- 2*mle_output$florida_8_5[[1]]$value + 2*mle_output$florida_8_5[[2]]$value + 2*mle_output$florida_8_5[[3]]$value + 2*mle_output$florida_8_5[[4]]$value + 2*mle_output$florida_8_5[[5]]$value + 2*mle_output$florida_8_5[[6]]$value + 2*mle_output$florida_8_5[[7]]$value + 2*mle_output$florida_8_5[[8]]$value + 2*mle_output$florida_8_5[[9]]$value  

+ 2*mle_output$florida_8_3[[1]]$value +
2*mle_output$florida_8_3[[2]]$value + 2*mle_output$florida_8_3[[3]]$value + 2*mle_output$florida_8_3[[4]]$value + 2*mle_output$florida_8_3[[5]]$value + 2*mle_output$florida_8_3[[6]]$value + 2*mle_output$florida_8_3[[7]]$value + 2*mle_output$florida_8_3[[8]]$value + 2*mle_output$florida_8_3[[9]]$value +

+ 2*mle_output$oregon_6_2[[1]]$value + 
2*mle_output$oregon_6_2[[2]]$value + 2*mle_output$oregon_6_2[[3]]$value + 2*mle_output$oregon_6_2[[4]]$value + 2*mle_output$oregon_6_2[[5]]$value + 2*mle_output$oregon_6_2[[6]]$value + 2*mle_output$oregon_6_2[[7]]$value + 2*mle_output$oregon_6_2[[8]]$value + 2*mle_output$oregon_6_2[[9]]$value +

+ 2*mle_output$oregon_7_1[[1]]$value +
2*mle_output$oregon_7_1[[2]]$value + 2*mle_output$oregon_7_1[[3]]$value + 2*mle_output$oregon_7_1[[4]]$value + 2*mle_output$oregon_7_1[[5]]$value + 2*mle_output$oregon_7_1[[6]]$value + 2*mle_output$oregon_7_1[[7]]$value + 2*mle_output$oregon_7_1[[8]]$value + 2*mle_output$oregon_7_1[[9]]$value ## model with 144 parameters, minus 16
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,128)  
    pval    
    
```

*Disturbence-level hierarchy*
```{r}


## SANN is time intensive
run_optim <- function (conditional, disturbences_names){
  conditional <- conditional & single_disturbence$dist_name == disturbences_names
  PR <-  optim(ic,MMLnLpower,method = "L-BFGS-B", ratio = single_disturbence[conditional,]$ratio, sizw = na.omit(single_disturbence[conditional,]$sizw))
  return(PR)
}


    
     ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3
    mle_output$all_dist <- list()
    failed_total <- 0
    failed_names <- c("")
    length_dists <- 0
  for (i in seq_along(names)){
    
  mle_output$all_dist[[i]] <- run_optim(conditional, names[i])
  
  print(paste(names[i], "--------------------------------------------------------------------------"))
  if (mle_output$all_dist[[i]]$convergence > 0){
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  length_dists <- length_dists + length(single_disturbence[conditional_or_7_1 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_or_7_1,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      print(paste("ERROR: INVALID subset, disturbences length :",length_dists, "ecoregion length", length(single_disturbence[conditional_or_7_1,]$ratio)))
    }
  }
  }
  failed_names  

  dev.null <-  2*all_param$value    ##null model, 4 params
    dev.tmt  <- 2*mle_output$all_dist[[1]]$value + 2*mle_output$all_dist[[2]]$value + 2*mle_output$all_dist[[3]]$value + 2*mle_output$all_dist[[4]]$value + 2*mle_output$all_dist[[5]]$value + 2*mle_output$all_dist[[6]]$value + 2*mle_output$all_dist[[7]]$value  + 2*mle_output$all_dist[[8]]$value +2* mle_output$all_dist[[9]]$value   ## model with 9*4 parameters, minus 4 parameters is 32
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,34)  ## extreamly large pvalue
    pval 
    
    

##  Disturbence down test Florida
    
    ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "FL"
    failed_total <- 0
    failed_names <- c("")
    length_dists <- 0
  for (i in seq_along(names)){
  mle_output$all_dist_fl[[i]] <- run_optim(conditional, names[i])
  if (mle_output$all_dist_fl[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  length_dists <- length_dists + length(single_disturbence[conditional_or_7_1 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_or_7_1,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      print(paste("ERROR: INVALID subset, disturbences length :",length_dists, "ecoregion length", length(single_disturbence[conditional_or_7_1,]$ratio)))
    }
  }
  }
  failed_names  
    
  run_optim <- function (conditional, disturbences_names){
  conditional <- conditional & single_disturbence$dist_name == disturbences_names
  PR <-  optim(ic,MMLnLpower,method = "SANN", ratio = single_disturbence[conditional,]$ratio, sizw = na.omit(single_disturbence[conditional,]$sizw))
  return(PR)
}
    # Oregon
    ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "OR"
    failed_total <- 0
    failed_names <- c("")
    length_dists <- 0
  for (i in seq_along(names)){
  mle_output$all_dist_or[[i]] <- run_optim(conditional, names[i])
  if (mle_output$all_dist_or[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  length_dists <- length_dists + length(single_disturbence[conditional_or_7_1 & single_disturbence$dist_name ==  names[i], ]$ratio)
  
  if(i == length(names)){
    if(length_dists == length(single_disturbence[conditional_or_7_1,]$ratio)){
      print(paste("Valid subset"))
    }else{
      
      print(paste("ERROR: INVALID subset, disturbences length :",length_dists, "ecoregion length", length(single_disturbence[conditional_or_7_1,]$ratio)))
    }
  }
  }
  failed_names

  dev.null <- 2*mle_output$all_dist[[1]]$value + 2*mle_output$all_dist[[2]]$value + 2*mle_output$all_dist[[3]]$value + 2*mle_output$all_dist[[4]]$value + 2*mle_output$all_dist[[5]]$value + 2*mle_output$all_dist[[6]]$value + 2*mle_output$all_dist[[7]]$value  + 2*mle_output$all_dist[[8]]$value +2*mle_output$all_dist[[9]]$value    ##null model,36 params
  
    dev.tmt  <- 2*mle_output$all_dist_fl[[1]]$value + 2*mle_output$all_dist_fl[[2]]$value + 2*mle_output$all_dist_fl[[3]]$value + 2*mle_output$all_dist_fl[[4]]$value + 2*mle_output$all_dist_fl[[5]]$value +2*mle_output$all_dist_fl[[6]]$value + 2*mle_output$all_dist_fl[[7]]$value + 2*mle_output$all_dist_fl[[8]]$value +  2*mle_output$all_dist_fl[[9]]$value + 
      
2*mle_output$all_dist_or[[1]]$value +
2*mle_output$all_dist_or[[2]]$value + 2*mle_output$all_dist_or[[3]]$value + 2*mle_output$all_dist_or[[4]]$value + 2*mle_output$all_dist_or[[5]]$value + 2*mle_output$all_dist_or[[6]]$value + 2*mle_output$all_dist_or[[7]]$value + 2*mle_output$all_dist_or[[8]]$value +  2*mle_output$all_dist_or[[9]]$value   ## model with 
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,36)  
    pval 
    
```


## Ploting curves of interior/total ratio

```{r, echo = TRUE}

length <- length(single_disturbence[null_model_conditional & single_disturbence$state == "FL",]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)

### State based figures
#final %>% 
  #filter(state == "FL") %>%
single_disturbence[null_model_conditional & single_disturbence$state == "FL",] %>%
ggplot(aes(sizw, ratio), show.legend = TRUE) +
  geom_hex() + 
  geom_line(aes(x =seq  , y = (upper )), color = "black")+
  geom_line(aes(x =seq , y = (lower )), color = "black")+
  geom_line(aes(x = seq, y = ( fl_8_3$par[2]*seq^fl_8_3$par[3])/(fl_8_3$par[1] + seq^fl_8_3$par[3]) ), color = eco_region_colors[4])+ #plotting fl_8_3
  geom_line(aes(x = seq, y = (fl_8_5$par[2]*seq^fl_8_5$par[3])/(fl_8_5$par[1] + seq^fl_8_5$par[3]) ), color = eco_region_colors[3])+ #plotting fl_8_5
  scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      legend.title = element_blank()
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Area ha") +
  ylab("Interior / Total ratio")+ 
  ggtitle("Florida")+
  theme(panel.background = element_blank())


length <- length(single_disturbence[null_model_conditional & single_disturbence$state == "OR",]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)

## State-based figures
#final %>% 
  #filter(state == "FL") %>%
single_disturbence[null_model_conditional & single_disturbence$state == "OR",] %>%
ggplot(aes(sizw, ratio), show.legend = TRUE) +
  geom_hex() + 
  geom_line(aes(x =seq  , y = (upper )), color = "black")+
  geom_line(aes(x =seq , y = (lower )), color = "black")+
  geom_line(aes(x = seq, y = ( or_6_2$par[2]*seq^or_6_2$par[3])/(or_6_2$par[1] + seq^or_6_2$par[3]) ), color = eco_region_colors[1])+ # 6.2
  geom_line(aes(x = seq, y = (or_7_1$par[2]*seq^or_7_1$par[3])/(or_7_1$par[1] + seq^or_7_1$par[3]) ), color = eco_region_colors[2])+ # 7.1
   scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      legend.title = element_blank()
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Area ha") +
  ylab("Interior / Total ratio")+ 
  ggtitle("Oregon")+
  theme(panel.background = element_blank())
```

```{r}
length <- length(single_disturbence[null_model_conditional,]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)

### Disturbances 

## Add params to single disturbence dataset to that ggplot will make it pretty
# single_disturbence <- as.list.data.frame(single_disturbence)
# single_disturbence$param_1 <- rep(NA, length(single_disturbence) )
# single_disturbence$param_2 <- rep(NA, length(single_disturbence) )
# single_disturbence$param_3 <- rep(NA, length(single_disturbence) )
# 
# for( i in seq_along(disturbences_names)){
#   single_disturbence[single_disturbence$dist_name == disturbences_names[i]]$param_1 <- mle_output$all_dist[[i]]$par[1]
#   single_disturbence[single_disturbence$dist_name == disturbences_names[i]]$param_2 <- mle_output$all_dist[[i]]$par[2]
#   single_disturbence[single_disturbence$dist_name == disturbences_names[i]]$param_3 <- mle_output$all_dist[[i]]$par[3]
# }
# single_disturbence <- as.data.frame(single_disturbence)

### Disturbances hex only
 single_disturbence[null_model_conditional, ] %>%
ggplot(aes(sizw, ratio, color = dist_name), show.legend = FALSE) +
  geom_hex() + 
  geom_line(aes(x =seq   , y = (upper )), color = "black")+
  geom_line(aes(x =seq  , y = (lower )), color = "black")+
  # geom_line(aes(x =seq, (mle_output$all_dist[[1]]$par[2]*seq^mle_output$all_dist[[1]]$par[3])/(mle_output$all_dist[[1]]$par[1] + seq^mle_output$all_dist[[1]]$par[3])))+
  #  geom_line(aes(x =seq, (mle_output$all_dist[[2]]$par[2]*seq^mle_output$all_dist[[2]]$par[3])/(mle_output$all_dist[[2]]$par[1] + seq^mle_output$all_dist[[2]]$par[3])))+
  #  geom_line(aes(x =seq, (mle_output$all_dist[[3]]$par[2]*seq^mle_output$all_dist[[3]]$par[3])/(mle_output$all_dist[[3]]$par[1] + seq^mle_output$all_dist[[3]]$par[3])))+
  #  geom_line(aes(x =seq, (mle_output$all_dist[[4]]$par[2]*seq^mle_output$all_dist[[4]]$par[3])/(mle_output$all_dist[[4]]$par[1] + seq^mle_output$all_dist[[4]]$par[3])))+
  #    geom_line(aes(x =seq, (mle_output$all_dist[[5]]$par[2]*seq^mle_output$all_dist[[5]]$par[3])/(mle_output$all_dist[[5]]$par[1] + seq^mle_output$all_dist[[5]]$par[3])))+
  #   geom_line(aes(x =seq, (mle_output$all_dist[[6]]$par[2]*seq^mle_output$all_dist[[6]]$par[3])/(mle_output$all_dist[[6]]$par[1] + seq^mle_output$all_dist[[6]]$par[3])))+
  #    geom_line(aes(x =seq, (mle_output$all_dist[[7]]$par[2]*seq^mle_output$all_dist[[7]]$par[3])/(mle_output$all_dist[[7]]$par[1] + seq^mle_output$all_dist[[7]]$par[3])))+
  #    geom_line(aes(x =seq, (mle_output$all_dist[[8]]$par[2]*seq^mle_output$all_dist[[8]]$par[3])/(mle_output$all_dist[[8]]$par[1] + seq^mle_output$all_dist[[8]]$par[3])))+
  #   geom_line(aes(x =seq, (mle_output$all_dist[[9]]$par[2]*seq^mle_output$all_dist[[9]]$par[3])/(mle_output$all_dist[[9]]$par[1] + seq^mle_output$all_dist[[9]]$par[3])))+
scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      legend.title = element_blank()
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("All Disturbances") + 
  scale_color_manual(values= disturbence_colors)+
  xlab("Area ha") +
  ylab("Interior / Total Ratio ")+ 
  ggtitle("Disturbance Types")+
  theme(panel.background = element_blank())

### Disturbance Model lines
 length <- length(single_disturbence[null_model_conditional,]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)

 single_disturbence[null_model_conditional, ] %>%
ggplot(aes(sizw, ratio), show.legend = TRUE) +
  geom_hex(aes(sizw, ratio)) + 
  geom_line(aes(x =seq   , y = (upper )), color = "black")+
  geom_line(aes(x =seq  , y = (lower )), color = "black")+
  geom_line(aes(x =seq, (mle_output$all_dist[[1]]$par[2]*seq^mle_output$all_dist[[1]]$par[3])/(mle_output$all_dist[[1]]$par[1] + seq^mle_output$all_dist[[1]]$par[3])), color = disturbence_colors[7])+ #5
   geom_line(aes(x =seq, (mle_output$all_dist[[2]]$par[2]*seq^mle_output$all_dist[[2]]$par[3])/(mle_output$all_dist[[2]]$par[1] + seq^mle_output$all_dist[[2]]$par[3])), color = disturbence_colors[5])+
   geom_line(aes(x =seq, (mle_output$all_dist[[3]]$par[2]*seq^mle_output$all_dist[[3]]$par[3])/(mle_output$all_dist[[3]]$par[1] + seq^mle_output$all_dist[[3]]$par[3]) ), color = disturbence_colors[4] )+
   geom_line(aes(x =seq, (mle_output$all_dist[[4]]$par[2]*seq^mle_output$all_dist[[4]]$par[3])/(mle_output$all_dist[[4]]$par[1] + seq^mle_output$all_dist[[4]]$par[3])), color = disturbence_colors[8])+
     geom_line(aes(x =seq, (mle_output$all_dist[[5]]$par[2]*seq^mle_output$all_dist[[5]]$par[3])/(mle_output$all_dist[[6]]$par[1] + seq^mle_output$all_dist[[5]]$par[3])), color = disturbence_colors[6])+
    geom_line(aes(x =seq, (mle_output$all_dist[[6]]$par[2]*seq^mle_output$all_dist[[6]]$par[3])/(mle_output$all_dist[[6]]$par[1] + seq^mle_output$all_dist[[6]]$par[3])), color = disturbence_colors[3])+
     geom_line(aes(x =seq, (mle_output$all_dist[[7]]$par[2]*seq^mle_output$all_dist[[7]]$par[3])/(mle_output$all_dist[[7]]$par[1] + seq^mle_output$all_dist[[7]]$par[3])), color = disturbence_colors[2])+
     geom_line(aes(x =seq, (mle_output$all_dist[[8]]$par[2]*seq^mle_output$all_dist[[8]]$par[3])/(mle_output$all_dist[[8]]$par[1] + seq^mle_output$all_dist[[8]]$par[3])),color = disturbence_colors[1] )+
    geom_line(aes(x =seq, (mle_output$all_dist[[9]]$par[2]*seq^mle_output$all_dist[[9]]$par[3])/(mle_output$all_dist[[9]]$par[1] + seq^mle_output$all_dist[[9]]$par[3])), color = disturbence_colors[9])+
scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      #legend.position= "none"
      legend.title = element_blank()
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Disturbance Event Size (ha)") + 
  scale_color_manual(values= disturbence_colors)+
  xlab("Area ha") +
  ylab("Interior / Total Ratio ")+ 
  ggtitle("All Disturbances")+
  theme(panel.background = element_blank())
 
 ### Disturbance by state FL
length <- length(single_disturbence[null_model_conditional & single_disturbence$state == "FL",]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)
 single_disturbence[null_model_conditional & single_disturbence$state == "FL", ] %>%
ggplot(aes(sizw, ratio), show.legend = FALSE) +
  geom_hex() + 
  geom_line(aes(x =seq   , y = (upper )), color = "black")+
  geom_line(aes(x =seq  , y = (lower )), color = "black")+
  geom_line(aes(x =seq, (mle_output$all_dist_fl[[1]]$par[2]*seq^mle_output$all_dist_fl[[1]]$par[3])/(mle_output$all_dist_fl[[1]]$par[1] + seq^mle_output$all_dist_fl[[1]]$par[3]) ), color = disturbence_colors[7])+ #5
   geom_line(aes(x =seq, (mle_output$all_dist_fl[[2]]$par[2]*seq^mle_output$all_dist_fl[[2]]$par[3])/(mle_output$all_dist_fl[[2]]$par[1] + seq^mle_output$all_dist_fl[[2]]$par[3]) ), color = disturbence_colors[5])+
   geom_line(aes(x =seq, (mle_output$all_dist_fl[[3]]$par[2]*seq^mle_output$all_dist_fl[[3]]$par[3])/(mle_output$all_dist_fl[[3]]$par[1] + seq^mle_output$all_dist_fl[[3]]$par[3]) ), color = disturbence_colors[4] )+
   geom_line(aes(x =seq, (mle_output$all_dist_fl[[4]]$par[2]*seq^mle_output$all_dist_fl[[4]]$par[3])/(mle_output$all_dist_fl[[4]]$par[1] + seq^mle_output$all_dist_fl[[4]]$par[3]) ), color = disturbence_colors[8])+
     geom_line(aes(x =seq, (mle_output$all_dist_fl[[5]]$par[2]*seq^mle_output$all_dist_fl[[5]]$par[3])/(mle_output$all_dist_fl[[6]]$par[1] + seq^mle_output$all_dist_fl[[5]]$par[3])  ), color = disturbence_colors[6])+
    geom_line(aes(x =seq, (mle_output$all_dist_fl[[6]]$par[2]*seq^mle_output$all_dist_fl[[6]]$par[3])/(mle_output$all_dist_fl[[6]]$par[1] + seq^mle_output$all_dist_fl[[6]]$par[3])), color = disturbence_colors[3])+
     geom_line(aes(x =seq, (mle_output$all_dist_fl[[7]]$par[2]*seq^mle_output$all_dist_fl[[7]]$par[3])/(mle_output$all_dist_fl[[7]]$par[1] + seq^mle_output$all_dist_fl[[7]]$par[3])  ), color = disturbence_colors[2])+
     geom_line(aes(x =seq, (mle_output$all_dist_fl[[8]]$par[2]*seq^mle_output$all_dist_fl[[8]]$par[3])/(mle_output$all_dist_fl[[8]]$par[1] + seq^mle_output$all_dist_fl[[8]]$par[3]) ),color = disturbence_colors[1] )+
    geom_line(aes(x =seq, (mle_output$all_dist_fl[[9]]$par[2]*seq^mle_output$all_dist_fl[[9]]$par[3])/(mle_output$all_dist_fl[[9]]$par[1] + seq^mle_output$all_dist_fl[[9]]$par[3])    ), color = disturbence_colors[9])+
scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      legend.position= "none"
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Disturbance Event Size (ha)") + 
  scale_color_manual(values= disturbence_colors)+
  xlab("Area ha") +
  ylab("Interior / Total Ratio ")+ 
  ggtitle("Florida")+
  theme(panel.background = element_blank())
  
 
 ### Disturbance by state OR
 length <- length(single_disturbence[null_model_conditional & single_disturbence$state == "OR",]$sizw)
length <- length + 1
seq <- c(2:length)
seq[length(seq)] <- max(single_disturbence[null_model_conditional,]$sizw)
lower <- lower_bound_ratios(seq)
upper <- upper_bound_ratios(seq)
 
 
  single_disturbence[null_model_conditional & single_disturbence$state == "OR", ] %>%
ggplot(aes(sizw, ratio), show.legend = TRUE) +
  geom_hex() + 
  geom_line(aes(x =seq   , y = (upper )), color = "black")+
  geom_line(aes(x =seq  , y = (lower )), color = "black")+
  geom_line(aes(x =seq, (mle_output$all_dist_or[[1]]$par[2]*seq^mle_output$all_dist_or[[1]]$par[3])/(mle_output$all_dist_or[[1]]$par[1] + seq^mle_output$all_dist_or[[1]]$par[3])   ), color = disturbence_colors[7])+ #5
   geom_line(aes(x =seq, (mle_output$all_dist_or[[2]]$par[2]*seq^mle_output$all_dist_or[[2]]$par[3])/(mle_output$all_dist_or[[2]]$par[1] + seq^mle_output$all_dist_or[[2]]$par[3])   ), color = disturbence_colors[5])+
   geom_line(aes(x =seq, (mle_output$all_dist_or[[3]]$par[2]*seq^mle_output$all_dist_or[[3]]$par[3])/(mle_output$all_dist_or[[3]]$par[1] + seq^mle_output$all_dist_or[[3]]$par[3])  ), color = disturbence_colors[4] )+
   geom_line(aes(x =seq, (mle_output$all_dist_or[[4]]$par[2]*seq^mle_output$all_dist_or[[4]]$par[3])/(mle_output$all_dist_or[[4]]$par[1] + seq^mle_output$all_dist_or[[4]]$par[3])  ), color = disturbence_colors[8])+
     geom_line(aes(x =seq, (mle_output$all_dist_or[[5]]$par[2]*seq^mle_output$all_dist_or[[5]]$par[3])/(mle_output$all_dist_or[[6]]$par[1] + seq^mle_output$all_dist_or[[5]]$par[3])    ), color = disturbence_colors[6])+
    geom_line(aes(x =seq, (mle_output$all_dist_or[[6]]$par[2]*seq^mle_output$all_dist_or[[6]]$par[3])/(mle_output$all_dist_or[[6]]$par[1] + seq^mle_output$all_dist_or[[6]]$par[3])  ), color = disturbence_colors[3])+
     geom_line(aes(x =seq, (mle_output$all_dist_or[[7]]$par[2]*seq^mle_output$all_dist_or[[7]]$par[3])/(mle_output$all_dist_or[[7]]$par[1] + seq^mle_output$all_dist_or[[7]]$par[3])   ), color = disturbence_colors[2])+
     geom_line(aes(x =seq, (mle_output$all_dist_or[[8]]$par[2]*seq^mle_output$all_dist_or[[8]]$par[3])/(mle_output$all_dist_or[[8]]$par[1] + seq^mle_output$all_dist_or[[8]]$par[3])   ),color = disturbence_colors[1] )+
    geom_line(aes(x =seq, (mle_output$all_dist_or[[9]]$par[2]*seq^mle_output$all_dist_or[[9]]$par[3])/(mle_output$all_dist_or[[9]]$par[1] + seq^mle_output$all_dist_or[[9]]$par[3])    ), color = disturbence_colors[9])+
scale_x_continuous(trans="log") +
scale_fill_gradient(trans = "log", breaks = c(1,10,100, 500),  low = "#636363", high = "#bdbdbd") +
   theme(panel.background = element_blank(),
      #axis.text.y = element_blank(),
      #axis.title.y = element_blank(),
      #axis.ticks.y = element_blank(),
      axis.text.x = element_text(size=14),
      axis.text.y = element_text(size=14), 
      #legend.position= "none"
      ) + 
scale_x_log10(
   breaks = scales::trans_breaks("log10", function(x) 10^x),
   labels = scales::trans_format("log10", scales::math_format(10^.x))
 )+ 
  xlab("Disturbance Event Size (ha)") + 
  scale_color_manual(values= disturbence_colors)+
  xlab("Area ha") +
  ylab("Interior / Total Ratio ")+ 
  ggtitle("Oregon")+
  theme(panel.background = element_blank())
  

```

# Trying dist by ecoregion - essentially cutting out state from hierachy not significant
```{r}

##  Disturbence down ecoregions
    
    ## 8.5
    ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$eco_II == "8.5"
    failed_total <- 0
    failed_names <- c("")
    
  for (i in seq_along(names)){
    
    if(names[i]  %in% c("Clearcut" )){
    ic=c(6, 1, 1 ,0.0005)
    }else if(names[i]  %in% c("Herbicide")){
     ic=c(6, 1, 4 ,0.0005)
  
    }else{
     ic=c(4, 0.9411, 0.7029 ,0.0546)
  }
  
  mle_output$all_dist_8_5[[i]] <- run_optim(conditional, names[i])
  
  if (mle_output$all_dist_8_5[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  failed_names
  
    ### 8.3
     ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$eco_II == "8.3"
    failed_total <- 0
    failed_names <- c("")
    
  for (i in seq_along(names)){
    
    if(names[i]  %in% c("Clearcut" )){
    ic=c(6, 1, 1 ,0.0005)
    }else if(names[i]  %in% c("Herbicide")){
     ic=c(6, 1, 4 ,0.0005)
  
    }else{
     ic=c(4, 0.9411, 0.7029 ,0.0546)
  }
  
  mle_output$all_dist_8_3[[i]] <- run_optim(conditional, names[i])
  
  if (mle_output$all_dist_8_3[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  failed_names
  
  ## 6.2
  
  ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$eco_II == "6.2"
    failed_total <- 0
    failed_names <- c("")
    
  for (i in seq_along(names)){
    
    if(names[i]  %in% c("Clearcut" )){
    ic=c(6, 1, 1 ,0.0005)
    }else if(names[i]  %in% c("Herbicide")){
     ic=c(6, 1, 4 ,0.0005)
  
    }else{
     ic=c(4, 0.9411, 0.7029 ,0.0546)
  }
  
  mle_output$all_dist_6_2[[i]] <- run_optim(conditional, names[i])
  
  if (mle_output$all_dist_6_2[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  
  ## 7.1
 ic=c(4, 0.94, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$eco_II == "7.1"
    failed_total <- 0
    failed_names <- c("")
    
  for (i in seq_along(names)){
    
    if(names[i]  %in% c("Clearcut" )){
    ic=c(6, 1, 1 ,0.0005)
    }else if(names[i]  %in% c("Herbicide")){
     ic=c(6, 1, 4 ,0.0005)
  
    }else{
     ic=c(4, 0.9411, 0.7029 ,0.0546)
  }
  
  mle_output$all_dist_7_1[[i]] <- run_optim(conditional, names[i])
  
  if (mle_output$all_dist_7_1[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  } 
    failed_names
    
    
  dev.null <-  2*mle_output$all_dist[[1]]$value + 2*mle_output$all_dist[[2]]$value + 2*mle_output$all_dist[[3]]$value + 2*mle_output$all_dist[[4]]$value + 2*mle_output$all_dist[[5]]$value + mle_output$all_dist[[6]]$value + mle_output$all_dist[[7]]$value    ##null model, 8 params
    dev.tmt  <- 2*mle_output$all_dist_8_3[[1]]$value + 2*mle_output$all_dist_8_3[[2]]$value + 2*mle_output$all_dist_8_3[[3]]$value + 2*mle_output$all_dist_8_3[[4]]$value + 2*mle_output$all_dist_8_3[[5]]$value + mle_output$all_dist_8_3[[6]]$value + mle_output$all_dist_8_3[[7]]$value + 2*mle_output$all_dist_8_5[[1]]$value + 2*mle_output$all_dist_8_5[[2]]$value + 2*mle_output$all_dist_8_5[[3]]$value + 2*mle_output$all_dist_8_5[[4]]$value + 2*mle_output$all_dist_8_5[[5]]$value + mle_output$all_dist_8_5[[6]]$value + mle_output$all_dist_8_5[[7]]$value + 
       2*mle_output$all_dist_6_2[[1]]$value + 2*mle_output$all_dist_6_2[[2]]$value + 2*mle_output$all_dist_6_2[[3]]$value + 2*mle_output$all_dist_6_2[[4]]$value + 2*mle_output$all_dist_6_2[[5]]$value + mle_output$all_dist_6_2[[6]]$value + mle_output$all_dist_6_2[[7]]$value + 2*mle_output$all_dist_7_1[[1]]$value + 2*mle_output$all_dist_7_1[[2]]$value + 2*mle_output$all_dist_7_1[[3]]$value + 2*mle_output$all_dist_7_1[[4]]$value + 2*mle_output$all_dist_7_1[[5]]$value + mle_output$all_dist_7_1[[6]]$value + mle_output$all_dist_7_1[[7]]$value  ## model with 28 * 4 or 112 parameters, minus 28 parameters 
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,84)  
    pval #Super little

```

# Not sig dist by state by ecoregion 
```{r, echo = TRUE}
 
#### Eco region ###############################
 
    ## Oregon 7.1
ic=c(4, 0.941, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "OR" & single_disturbence$eco_II == "7.1"
    failed_total <- 0
    failed_names <- c("")

  for (i in seq_along(names)){
  mle_output$all_dist_or_7_1[[i]] <- run_optim(conditional, names[i])
  if (mle_output$all_dist_or_7_1[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
   ## Oregon 6.2
    
    ic=c(4, 0.9411, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "OR" & single_disturbence$eco_II == "6.2"
    failed_total <- 0
    failed_names <- c("")

  for (i in seq_along(names)){
  mle_output$all_dist_or_6_2[[i]] <- run_optim(conditional, names[i])
  if (mle_output$all_dist_or_6_2[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  
  ## Florida 8.3
  
   ic=c(4, 0.9411, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "FL" & single_disturbence$eco_II == "8.3"
    failed_total <- 0
    failed_names <- c("")

  for (i in seq_along(names)){
  mle_output$all_dist_fl_8_3[[i]] <- run_optim(conditional, names[i])
  if (mle_output$all_dist_fl_8_3[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  
  ## Florida 8.5  
   ic=c(4, 0.9411, 0.7029 ,0.0546)
    conditional <- single_disturbence$sizw > 3 & single_disturbence$state == "FL" & single_disturbence$eco_II == "8.5"
    failed_total <- 0
    failed_names <- c("")

  for (i in seq_along(names)){
    
    if(names[i]  %in% c("Clearcut" )){
    ic=c(6, 1, 1 ,0.0005)
    }else if(names[i]  %in% c("Herbicide")){
     ic=c(6, 1, 4 ,0.0005)
  
    }else{
     ic=c(4, 0.9411, 0.7029 ,0.0546)
  }
  
  mle_output$all_dist_fl_8_5[[i]] <- run_optim(conditional, names[i])
  
  if (mle_output$all_dist_fl_8_5[[i]]$convergence > 0){
    print(paste(names[i], "-------------------------------failed to converge--------------------------------------------------"))
    failed_total <- failed_total + 1
    failed_names <- c(failed_names, names[i])
  }
  }
  failed_names
    
    dev.null  <- 2*mle_output$all_dist_fl[[1]]$value + 2*mle_output$all_dist_fl[[2]]$value + 2*mle_output$all_dist_fl[[3]]$value + 2*mle_output$all_dist_fl[[4]]$value + 2*mle_output$all_dist_fl[[5]]$value + mle_output$all_dist_fl[[6]]$value + mle_output$all_dist_fl[[7]]$value + 2*mle_output$all_dist_or[[1]]$value + 2*mle_output$all_dist_or[[2]]$value + 2*mle_output$all_dist_or[[3]]$value + 2*mle_output$all_dist_or[[4]]$value + 2*mle_output$all_dist_or[[5]]$value + mle_output$all_dist_or[[6]]$value + mle_output$all_dist_or[[7]]$value   ## null model with 14 * 4 or 56 parameters 
    dev.tmt  <- 2*mle_output$all_dist_fl_8_3[[1]]$value + 2*mle_output$all_dist_fl_8_3[[2]]$value + 2*mle_output$all_dist_fl_8_3[[3]]$value + 2*mle_output$all_dist_fl_8_3[[4]]$value + 2*mle_output$all_dist_fl_8_3[[5]]$value + mle_output$all_dist_fl_8_3[[6]]$value + mle_output$all_dist_fl_8_3[[7]]$value + 2*mle_output$all_dist_fl_8_5[[1]]$value + 2*mle_output$all_dist_fl_8_5[[2]]$value + 2*mle_output$all_dist_fl_8_5[[3]]$value + 2*mle_output$all_dist_fl_8_5[[4]]$value + 2*mle_output$all_dist_fl_8_5[[5]]$value + mle_output$all_dist_fl_8_5[[6]]$value + mle_output$all_dist_fl_8_5[[7]]$value + 
       2*mle_output$all_dist_or_6_2[[1]]$value + 2*mle_output$all_dist_or_6_2[[2]]$value + 2*mle_output$all_dist_or_6_2[[3]]$value + 2*mle_output$all_dist_or_6_2[[4]]$value + 2*mle_output$all_dist_or_6_2[[5]]$value + mle_output$all_dist_or_6_2[[6]]$value + mle_output$all_dist_or_6_2[[7]]$value + 2*mle_output$all_dist_or_7_1[[1]]$value + 2*mle_output$all_dist_or_7_1[[2]]$value + 2*mle_output$all_dist_or_7_1[[3]]$value + 2*mle_output$all_dist_or_7_1[[4]]$value + 2*mle_output$all_dist_or_7_1[[5]]$value + mle_output$all_dist_or_7_1[[6]]$value + mle_output$all_dist_or_7_1[[7]]$value ### 112 parameters minus 56 is 56
    
    LR       <- dev.null - dev.tmt        ## Likelihood ratio
    pval     <- 1 - pchisq(LR,56)  
    pval # Not nested
```




